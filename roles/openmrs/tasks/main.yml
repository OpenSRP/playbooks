---
- name: Install MySQL client package
  become: yes
  become_user: "root"
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - mysql-client
    - python-mysqldb

- name: Create the OpenMRS MySQL Database
  mysql_db:
    login_host: "{{ openmrs_mysql_host }}"
    login_user: "{{ openmrs_mysql_root_user }}"
    login_password: "{{ openmrs_mysql_root_password }}"
    name: "{{ openmrs_mysql_database }}"
    state: present

- name: Create the OpenMRS MySQL User
  mysql_user:
    login_host: "{{ openmrs_mysql_host }}"
    login_user: "{{ openmrs_mysql_root_user }}"
    login_password: "{{ openmrs_mysql_root_password }}"
    name: "{{ openmrs_mysql_user }}"
    password: "{{ openmrs_mysql_password }}"
    host: "{{ openmrs_mysql_app_host }}"
    priv: "{{ openmrs_mysql_database }}.*:{{ openmrs_mysql_user_privilages }}"
    state: present

- name: Create OpenMRS Config Directory
  become: yes
  become_user: root
  file:
    path: "{{ openmrs_home_directory }}"
    owner: "{{ openmrs_system_user }}"
    group: "{{ openmrs_system_group }}"
    state: directory
    mode: 0775

- name: Create a symbolic link of the OpenMRS config directory
  become: yes
  become_user: root
  file:
    src: "{{ openmrs_home_directory }}"
    dest: "/var/lib/OpenMRS"
    owner: "{{ openmrs_system_user }}"
    group: "{{ openmrs_system_group }}"
    state: link
    mode: 0777

- name: Set OpenMRS facts based on version
  set_fact:
    openmrs_modules: "{{ openmrs_modules_v1 if (openmrs_version < 2) else openmrs_modules_v2 }}"
    template:
      "templates/conditionals/openmrs_version_template.j2"

- include_tasks: modules.yml
  when: openmrs_modules|length > 0

- name: Make sure the OpenMRS directory is absent in Tomcat's app directory
  become: yes
  become_user: root
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ openmrs_tomcat_user_home }}/{{ openmrs_tomcat_instance }}/webapps/{{ openmrs_install_name }}.war"
    - "{{ openmrs_tomcat_user_home }}/{{ openmrs_tomcat_instance }}/webapps/{{ openmrs_install_name }}"

- name: Install the OpenMRS Binary
  become: yes
  become_user: root
  get_url:
    url: "https://downloads.sourceforge.net/project/openmrs/releases/OpenMRS_Platform_{{ openmrs_version }}/openmrs.war"
    dest: "{{ openmrs_tomcat_user_home }}/{{ openmrs_tomcat_instance }}/webapps/{{ openmrs_install_name }}.war"
    owner: "{{ openmrs_system_user }}"
    group: "{{ openmrs_system_group }}"

- name: Check if the properties file is already on the server
  stat:
    path: "{{ openmrs_home_directory }}/openmrs-runtime.properties"
  register: openmrs_properties_file_status

- name: Include initial-setup.yml
  include_tasks: initial-setup.yml
  when: not openmrs_properties_file_status.stat.exists

- name: Include not-initial-setup.yml
  include_tasks: not-initial-setup.yml
  when: openmrs_properties_file_status.stat.exists

- name: Restart the Tomcat7 Service
  become: yes
  become_user: root
  service:
    name: "{{ openmrs_tomcat_instance }}"
    state: restarted
