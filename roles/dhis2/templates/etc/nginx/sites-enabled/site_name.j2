server {
    server_name  www.{{ site_name }};
    rewrite ^(.*) $scheme://{{ site_name }}$1 permanent;
}

server {
    # ports
    listen {{ dhis_nginx_http_port }};
    listen [::]:{{ dhis_nginx_http_port }};

    # server block/virtual host name
    server_name {{ site_name }};

    # force ssl
    return 301 https://$server_name$request_uri;
}

server {
    # ports
    listen {{ dhis_nginx_https_port }};
    listen [::]:{{ dhis_nginx_https_port }};

    # server block/virtual host name
    server_name {{ site_name }};

    include /etc/nginx/ssl-{{ site_name }}.conf;

    # entity size
    client_max_body_size {{ dhis_nginx_max_filesize }};

    location / {
        # backend
        proxy_pass        http://localhost:{{ dhis_tomcat_http_port }};
        proxy_read_timeout 60s;

        # headers
        proxy_set_header  Host             $host;
        proxy_set_header  X-Real-IP        $remote_addr;
        proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Host $server_name;
        proxy_set_header  X-Forwarded-Proto  https;

        # no redirects
        proxy_redirect    off;

        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;

        # max upload size
        client_max_body_size {{ dhis_nginx_max_filesize }};
    }
}
